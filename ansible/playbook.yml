---
- hosts: app
  become: true

  tasks:
    - name: Install Docker
      apt:
        name: docker.io
        state: present
        update_cache: yes

    - name: Start Docker
      service:
        name: docker
        state: started
        enabled: yes

    - name: Add user to docker group
      user:
        name: "{{ ansible_user }}"
        groups: docker
        append: yes

    - name: Create directory for app
      file:
        path: /home/chuck/app
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0755'

    - name: Copy application Dockerfile
      copy:
        src: ../Dockerfile
        dest: /home/chuck/app/Dockerfile

    - name: Copy application file
      copy:
        src: ../app/app.py
        dest: /home/chuck/app/app.py

    - name: Copy Nginx Dockerfile
      copy:
        src: ../Dockerfile.nginx
        dest: /home/chuck/app/Dockerfile.nginx

    - name: Copy Nginx config file
      copy:
        src: ../nginx.conf
        dest: /home/chuck/app/nginx.conf

    - name: Create network
      shell: |
        docker network create chuck-net

    - name: Build and run application container
      shell: |
        cd /home/chuck/app
        docker build -t app .
        docker run -d --name app --network chuck-net chuck-app
        

    - name: Build and run Nginx container
      shell: |
        cd /home/chuck/app
        docker build -t nginx-proxy -f nginx.Dockerfile .
        docker run -d -p 80:80 --name nginx --network chuck-net nginx-proxy